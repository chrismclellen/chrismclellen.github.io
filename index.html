<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
    <!-- <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> -->
    <!-- <meta http-equiv="Content-Security-Policy" content="

    script-src 'self' 'sha256-naltAMAYqBGX+71vQpM2FjFf/jGq1jKUIxEee+pGYqU=' https://unpkg.com/axios/dist/axios.min.js https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js;
    style-src-elem 'self' https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css 'sha256-s/nONyik3gL8ds1oA1nz67vcgB4VkNfZ1V8wWmvI0EE=';"> -->
    <title>IP FUCKING CAMERA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" 
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <!-- <script src="./js/ffmpeg.js" type="text/javascript"></script> -->
    <!-- <script type="text/javascript">
        if (navigator.appVersion.indexOf("iPod") == -1 && navigator.appVersion.indexOf("iPhone") == -1 && navigator.appName.indexOf("Microsoft Internet Explorer") == -1) {
            document.write("<script src='/js/commonff.js'/>");
            document.write("<script src='/js/pcm-player.js'/>");
            document.write("<script src='/js/video-player.js'/>");
            document.write("<script src='/js/webgl-player.js'/>");
        }
    </script> -->
    <script src="./js/libde265.js" type="text/javascript"></script>
    <script src="./js/commonff.js" type="text/javascript"></script>
    <script src="./js/pcm-player.js" type="text/javascript"></script>
    <script src="./js/video-player.js" type="text/javascript"></script>
    <script src="./js/webgl-player.js" type="text/javascript"></script>
    <script src="./js/base64.js" type="text/javascript"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        body {
            margin: 0px;
            padding: 0px;
            height: 100%;
            background-color: #434343;
            background-size: 75px 75px;
            background-image: linear-gradient(0deg, transparent 24%, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, .05) 75%, rgba(255, 255, 255, .05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, .05) 75%, rgba(255, 255, 255, .05) 76%, transparent 77%, transparent);
        }

        .vl {
            border-left: 3px solid red;
            height: 100vh;
            position: absolute;
            left: 50%;
            margin-left: 0px;
            top: 0px;
        }

        .hl {
            border-top: 3px solid red;
            width: 100vw;
            position: absolute;
            top: 50%;
            margin-top: 0px;
            left: 0px;
        }

        .btn {
            margin: 10px;
        }

        i {
            /* color: #77ff88; */
            filter: invert(1);
            /* border: 1px solid green; */
            margin: 5px;
        }
        .wide {
            width: 100vw
        }
    </style>
    <script type="text/javascript">

        var player = null;
        var ip = '192.168.0.39';
        var httpport = '80';
        var username = 'admin';
        var password = 'passw0rd123'
        var b64 = new Base64();
        var base64User = b64.encode(username + ":" + password);
        var vid = '';
        var stream = '11'; //stream 11 causes major lag, fucks everything up
        var status;

        window.addEventListener('load', function () {

            vid = document.getElementById('video_canvas')
            vid.width = window.innerWidth;
            vid.height = window.innerHeight;
            status = document.getElementById("status");

            start()

            function windowResize() {
                vid.width = window.innerWidth;
                vid.height = window.innerHeight;
            };

            window.addEventListener('resize', windowResize);

            // var elemLeft = vid.offsetLeft + vid.clientLeft,
            //     elemTop = vid.offsetTop + vid.clientTop,
            //     context = vid.getContext('2d'),
            //     elements = [];

            document.addEventListener('keydown', (e) => {
                if (e.code === "KeyZ" || e.code === "KeyX" || e.code.includes("Arrow")) {
                    e.preventDefault()
                    e.stopPropagation()
                }
                switch (e.code) {
                    case 'ArrowLeft':
                        ptzcmdSubmit('left')
                        break;
                    case 'ArrowRight':
                        ptzcmdSubmit('right')
                        break;
                    case 'ArrowUp':
                        ptzcmdSubmit('up')
                        break;
                    case 'ArrowDown':
                        ptzcmdSubmit('down')
                        break;
                    case 'KeyZ':
                        ptzcmdSubmit('zoomin')
                        break;
                    case 'KeyX':
                        ptzcmdSubmit('zoomout')
                        break;
                    default:
                    // console.log(e.code)
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.code === "KeyZ" || e.code === "KeyX" || e.code.includes("Arrow")) {
                    ptzcmdSubmit('stop')
                }
            });


            vid.addEventListener('mousedown', function (e) {
                xCenter = window.innerWidth / 2;
                yCenter = window.innerHeight / 2;
                xDelta = xCenter - e.offsetX;
                yDelta = yCenter - e.offsetY;
                xPercent = (xDelta / window.innerWidth);
                yPercent = (yDelta / window.innerHeight);
                rate = $('#rate').val();
                rate = 63 / rate;

                let upDown = (yPercent) => {
                    if (yPercent < 0) {
                        //move down
                        ptzcmdSubmit('down')
                        setTimeout(() => { ptzcmdSubmit('stop') }, Math.abs(yPercent) * (2100 * rate));
                    } else {
                        //move up
                        ptzcmdSubmit('up')
                        setTimeout(() => { ptzcmdSubmit('stop') }, Math.abs(yPercent) * (2100 * rate));
                    }
                }

                if (xPercent < 0) {
                    //move right
                    ptzcmdSubmit('right')
                    setTimeout(() => {
                        ptzcmdSubmit('stop');
                        upDown(yPercent);
                    }, Math.abs(xPercent) * (4000 * rate));
                } else if (xPercent > 0) {
                    //move left
                    ptzcmdSubmit('left')
                    setTimeout(() => {
                        ptzcmdSubmit('stop');
                        upDown(yPercent);
                    }, Math.abs(xPercent) * (4000 * rate));
                } else {
                    console.log('hey')
                    upDown(yPercent);
                }
            }, false)
        })

        function start() {
            // let video_canvas = document.getElementById("video_canvas");

            // older cam 
            player = libde265.RawPlayer(vid);


            // new cam
            // player = new HxPlayer();
            // player.init({canvas:vid}); //width:640, height:352


            // player.connect()
            // player.playvideo(ip, httpport, stream , username, password);

            
            // player.set_status_callback((e, f = '') => {
            //     let txt = document.getElementById("eml_recv");
            //     txt.value = e + " " + f;
            // })
            // player.set_status_callback(function (msg, fps) {
            //     switch (msg) {
            //         case "loading":
            //             status.innerHTML = "Loading movie...";
            //             break;
            //         case "initializing":
            //             status.innerHTML = "Initializing...";
            //             break;
            //         case "playing":
            //             status.innerHTML = "Playing...";
            //             break;
            //         case "stopped":
            //             status.innerHTML = "";
            //             break;
            //         case "fps":
            //             status.innerHTML = Number(fps).toFixed(2) + " fps";
            //             break;
            //         default:
            //             status.innerHTML = msg;
            //     }
            // });

            player.playvideo(ip, httpport, stream, username, password);
            getDays()
        }

        function stopchrome() {
            if (player != null) {
                player.stopvideo();
                player = null;
            }
        }

        var timer = 0;
        function ptzcmdSubmit(casename, step = 0) {
            if (timer === 0 && casename != 'stop') {
                timer = Date.now()
            }

            var speed = $('#rate').val()
            frame = document.getElementById('frame');
            frame.src = 'http://' + ip + '/web/cgi-bin/hi3510/ptzctrl.cgi?-step=' + step + '&-act=' + casename + '&-speed=' + speed;

            if (timer !== 0 && casename === 'stop') {
                console.log(Date.now() - timer)
                timer = 0
            }
        }
        function ptzout() {
            ptzcmdSubmit('stop');
        }
        function ptzctrlpresetSubmit(casenum) {
            frame = document.getElementById('frame');
            frame.src = 'http://' + ip + '/web/cgi-bin/hi3510/preset.cgi?-act=goto&-number=' + casenum;
        }
        function ptzsetpresetSubmit(casenum) {
            frame = document.getElementById('frame');
            frame.src = 'http://' + ip + '/web/cgi-bin/hi3510/preset.cgi?-act=set&-status=1&-number=' + casenum;
        }
        function set_preset() {
            var preset = document.getElementById('preset').value - 1;
            frame = document.getElementById('frame');
            frame.src = 'http://' + ip + '/web/cgi-bin/hi3510/param.cgi?cmd=preset&-act=set&-status=1&-number=' + preset;
        }
        function poscall_preset() {
            var preset = document.getElementById('preset').value - 1;
            frame = document.getElementById('frame');
            frame.src = 'http://' + ip + '/web/cgi-bin/hi3510/param.cgi?cmd=preset&-act=goto&-status=1&-number=' + preset;
        }
        function del_preset() {
            var preset = document.getElementById('preset').value - 1;
            frame = document.getElementById('frame');
            frame.src = 'http://' + ip + '/web/cgi-bin/hi3510/param.cgi?cmd=preset&-act=set&-status=0&-number=' + preset;
        }

        function playback2(file) {
            console.log("playing " + file)
            if (player) {
                player.stop();
            }
            // player.stopvideo()
            // player._reset()
            var video_canvas = document.getElementById("video_canvas");
            player = new libde265.RawPlayer(video_canvas);
            // player.set_status_callback((e, f = '') => {
            //     let txt = document.getElementById("eml_recv");
            //     txt.value = e + " " + f;
            // })
            player.playback(file);
        }


        function playback(file) {
            // event.preventDefault();
            if (player) {
                player.stopvideo() || player.stop();
                // player.stop();
            }

            player = new libde265.RawPlayer(vid);
            player.set_status_callback(function (msg, fps) {
                switch (msg) {
                    case "loading":
                        status.innerHTML = "Loading movie...";
                        break;
                    case "initializing":
                        status.innerHTML = "Initializing...";
                        break;
                    case "playing":
                        status.innerHTML = "Playing...";
                        break;
                    case "stopped":
                        status.innerHTML = "";
                        break;
                    case "fps":
                        status.innerHTML = Number(fps).toFixed(2) + " fps";
                        break;
                    default:
                        status.innerHTML = msg;
                }
            });
            player.playback(file);
        };


        function getDays() {
            let d = new Date();
            let y = d.getFullYear();
            let m = `${d.getMonth() + 1}`;
            m = m.padStart(2, '0');
            let day = `${d.getDate()}`;
            day = day.padStart(2, '0');
            let date = `${y}${m}${day}`;
            console.log(date)

            // headers = {
            //     'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
            //     "crossdomain" : "true",
            //     "Origin": "http://sparklight.com"
            // };

            axios.get(`http://${ip}/tmpfs/sd/${date}/recdata.db`) //127.0.0.1:8000/?get=
                .then(res => {
                    let regex = /tmpfs(.*?)\u0000/g;
                    let found = [...res.data.matchAll(regex)];
                    found = found.map(f => `http://${ip}${f[1]}`);
                    let alarms = found.filter(f => f.includes('/A'));
                    console.log(alarms, found);
                    let links = [];
                    alarms.forEach(a => {
                        let link = document.createElement('div');
                        let text = document.createTextNode(a);
                        // link.setAttribute('href', a);
                        link.setAttribute('onclick', 'javascript:playback("' + a + '")');
                        link.appendChild(text);
                        links.push(link)
                    })
                    document.getElementById('alarms').append(...links,);
                })
        }

        // rtsp://default:@192.168.0.39:554/11
        // http://192.168.0.39/livestream.cgi?stream=2&action=play&media=video_audio_data



    </script>
</head>

<body>

    <div class="vl"></div>
    <div class="hl"></div>
    <canvas id="video_canvas"></canvas>
    <div class="float-end">
        <input id="status" value="" type="text" readonly class="form-control-plaintext form-control-sm float-end" />
        <!-- eml_recv -->
    </div>

    <div class="container position-absolute bottom-0 wide">
        <div class="row">
            <div class="col-8 align-self-start">
                <table border="2px" align="left">
                    <tbody>
                        <tr>
                            <td>　</td>
                            <td><a onmouseout="ptzout()" onmousedown="ptzcmdSubmit('up')" onmouseup="ptzcmdSubmit('stop')">
                                    <h1><i class="bi bi-arrow-up-circle-fill"></i></h1>
                                </a></td>
                            <td>　</td>
                        </tr>
                        <tr>
                            <td><a onmouseout="ptzout()" onmousedown="ptzcmdSubmit('left')" onmouseup="ptzcmdSubmit('stop')">
                                    <h1><i class="bi bi-arrow-left-circle-fill"></i></h1>
                                </a></td>
                            <td><a onmouseout="ptzout()" onmousedown="ptzcmdSubmit('home')">
                                    <h1><i class="bi bi-house-fill"></i></h1>
                                </a></td>
                            <td><a onmouseout="ptzout()" onmousedown="ptzcmdSubmit('right')" onmouseup="ptzcmdSubmit('stop')">
                                    <h1><i class="bi bi-arrow-right-circle-fill"></i></h1>
                                </a></td>
                        </tr>
                        <tr>
                            <td>　</td>
                            <td><a onmouseout="ptzout()" onmousedown="ptzcmdSubmit('down')" onmouseup="ptzcmdSubmit('stop')">
                                    <h1><i class="bi bi-arrow-down-circle-fill"></i></h1>
                                </a></td>
                            <td>　</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col-2 align-self-center">
                <div class="container">

                    <div class="row">
                        <div class="col">
                            <button onclick="set_preset()" type="button" class="btn btn-primary">Submit</button>
                        </div>
                        <div class="col">
                            <button onclick="poscall_preset()" type="button" class="btn btn-primary">Call</button>
                        </div>
                        <div class="col">
                            <button onclick="del_preset()" type="button" class="btn btn-primary">Remove</button>
                        </div>
                    </div>
                    <div class ="row">
                        <div class ="col">
                            Rate <input data-prefix="Rate" id="rate" value="63" data-decimals="0" min="1" max="63" step="1" type="number" />
                        </div>
                        <div class ="col">
                            Preset <input data-prefix="Preset" id="preset" value="1" data-decimals="0" min="1" max="255" step="1" type="number" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-2 align-self-end">
                <div id="zoom">
                    <button type="button" class="btn btn-primary" onmousedown="ptzcmdSubmit('zoomin')"
                        onmouseup="ptzcmdSubmit('stop')">Zoom In</button>
                    <button type="button" class="btn btn-primary" onmousedown="ptzcmdSubmit('zoomout')"
                        onmouseup="ptzcmdSubmit('stop')">Zoom Out</button>
                </div>
        
                <div id="focus">
                    <button type="button" class="btn btn-primary" onmousedown="ptzcmdSubmit('focusin')"
                        onmouseup="ptzcmdSubmit('stop')">Focus In</button>
                    <button type="button" class="btn btn-primary" onmousedown="ptzcmdSubmit('focusout')"
                        onmouseup="ptzcmdSubmit('stop')">Focus Out</button>
                </div>
            </div>
        </div>
    </div>


    <div id="ptz" class="position-absolute bottom-0 start-0">

    </div>

    <div id="buttons" class="position-absolute bottom-0 end-0">

        <!-- <div id="scan">
            <button type="button" class="btn btn-primary" onclick="ptzcmdSubmit('hscan')">H Scan</button>
            <button type="button" class="btn btn-primary" onclick="ptzcmdSubmit('vscan')">V Scan</button>
        </div>
        <div id="pos" style="">
            <button type="button" class="btn btn-primary" onclick="ptzsetpresetSubmit('0')">Set 0</button>
            <button type="button" class="btn btn-primary" onclick="ptzctrlpresetSubmit('0')">Call 0</button>
        </div> -->
    </div>

    <div id="preset-rate" class="position-absolute bottom-0 container">

        <!-- <select name="speedselect" size="1" id="speedslct" class="form-control" >
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option><option value="31">31</option><option value="32">32</option><option value="33">33</option><option value="34">34</option><option value="35">35</option><option value="36">36</option><option value="37">37</option><option value="38">38</option><option value="39">39</option><option value="40">40</option><option value="41">41</option><option value="42">42</option><option value="43">43</option><option value="44">44</option><option value="45">45</option><option value="46">46</option><option value="47">47</option><option value="48">48</option><option value="49">49</option><option value="50">50</option><option value="51">51</option><option value="52">52</option><option value="53">53</option><option value="54">54</option><option value="55">55</option><option value="56">56</option><option value="57">57</option><option value="58">58</option><option value="59">59</option><option value="60">60</option><option value="61">61</option><option value="62">62</option><option value="63" selected="">63</option>
        </select> -->

    </div>

    
    <div id="alarms"></div>

    <!-- <textarea id="stuff" rows="40" cols="100"></textarea> -->
    <iframe id="frame" marginwidth="0" scrolling="auto" marginheight="0" noresize="" src=""
        style="visibility:hidden"></iframe>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
</body>

</html>